{"ts":1377178876523,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"(function(){\n    brif.modelClass.signIn = Backbone.Model.extend({\n        defaults: {            \n            apiKey: 'AIzaSyDQU5DYKmI1gvk-RGwLJFL0g2r0_Tm5Tko',\n            scopes: ['https://mail.google.com', 'https://www.google.com/m8/feeds/', 'https://www.googleapis.com/auth/calendar', 'https://www.googleapis.com/auth/userinfo.profile']\n        },\n        setApiKey: function(){\n            var that = this;\n            gapi.client.setApiKey(this.get('apiKey'));\n            window.setTimeout(function(){\n                // Check Authentication\n                gapi.auth.authorize({\n                    client_id: that.get('web').client_id, \n                    scope: that.get('scopes'),\n                    response_type : 'code token',\n                    immediate: true}, \n                    that.handleAuthResult);\n            \n            },1);\n        },\n        handleAuthResult: function(authResult){\n            if (authResult && !authResult.error) {\n                // Athorized already               \n                if(\n                    window.location.pathname == '/index.' + brif.models.config.get('signInFileType') ||\n                    window.location.pathname == '/') {\n                    window.location.assign(window.location.origin + '/app');\n                    return;\n                }\n                \n                brif.models.user.set('code', authResult.code);\n                \n                // Get user's name & email\n                $.ajax({\n                    url: 'https://www.google.com/m8/feeds/contacts/default/full/',\n                    dataType: 'xml',\n                    headers: {\n                        'Authorization': 'Bearer ' + authResult.access_token,\n                        'Gdata-version': '3.0'\n                    },\n                    success: function(resp){\n                        // resp holds by default the first 20 contacts we need to find just the user\n                        var userEmail = $(resp).find('feed author email').text();\n                        var userName = $(resp).find('feed author name').text();\n                        brif.models.user.set('email', userEmail);\n                        brif.models.user.set('name', userName);\n                        // Sign in with brif\n                        brif.models.user.save({\n                            success: function(resp){\n                                console.log(resp);\n                            }, \n                            error: function(err){\n                                console.log(err);\n                            }\n                        });\n                    }\n                });\n                \n                // Get user info\n                // gapi.client.load('oauth2', 'v2', function() {\n                //     var request = gapi.client.oauth2.userinfo.get();\n                //     request.execute(function(userInfo) {                        \n                //         console.log(userInfo);\n                //     });\n                // });\n                \n            } else {\n                // Still need to authorize\n                if(\n                    window.location.pathname == 'app/index.' + brif.models.config.get('signInFileType') ||\n                    window.location.pathname == '/app/') {\n                    window.location.assign(window.location.origin);\n                } else {\n                    brif.models.signIn.trigger('not authorized');\n                }\n            }\n        }\n    });\n    brif.models.signIn = new brif.modelClass.signIn({\n        web: brif.models.config.get('googleSecret')\n    });\n})();"]],"start1":0,"start2":0,"length1":0,"length2":3618}]],"length":3618}
{"contributors":[],"silentsave":true,"ts":1377178885503,"patch":[[{"diffs":[[0,"});\n"],[-1,"    brif.models.signIn = new brif.modelClass.signIn({\n        web: brif.models.config.get('googleSecret')\n    });\n"],[0,"})()"]],"start1":3495,"start2":3495,"length1":122,"length2":8}]],"length":3504,"saved":false}
{"ts":1377178991403,"patch":[[{"diffs":[[0,"    });\n"],[1,"    brif.models.signIn = new brif.modelClass.signIn({\n        web: brif.models.config.get('googleSecret')\n    });\n"],[0,"})();"]],"start1":3491,"start2":3491,"length1":13,"length2":127}]],"length":3618,"saved":false}
{"contributors":[],"silentsave":true,"ts":1377502767172,"patch":[[{"diffs":[[0," bri"],[-1,"f\n                        brif.models.user.save({\n                            success: function(resp){\n                                console.log(resp);\n                            }, \n                            error: function(err){\n                                console.log(err);\n                            }\n                        });"],[0,"\n   "]],"start1":2262,"start2":2262,"length1":351,"length2":8}]],"length":3275,"saved":false}
{"ts":1377502767861,"patch":[[{"diffs":[[0,"    "],[-1,"// Sign in with bri"],[0,"\n   "]],"start1":2243,"start2":2243,"length1":27,"length2":8}]],"length":3256,"saved":false}
{"ts":1377502769830,"patch":[[{"diffs":[[0,"e);\n"],[-1,"                        \n"],[0,"    "]],"start1":2219,"start2":2219,"length1":33,"length2":8}]],"length":3231,"saved":false}
{"ts":1377502775678,"patch":[[{"diffs":[[0,"   \n"],[-1,"                // Get user info\n                // gapi.client.load('oauth2', 'v2', function() {\n                //     var request = gapi.client.oauth2.userinfo.get();\n                //     request.execute(function(userInfo) {                        \n                //         console.log(userInfo);\n                //     });\n                // });\n                \n"],[0,"    "]],"start1":2278,"start2":2278,"length1":379,"length2":8}]],"length":2860,"saved":false}
